#!/usr/bin/env bash
set -o errexit -o errtrace -o nounset -o pipefail

goreleaser build --clean --snapshot --single-target

# Use the autogenerated goreleaser manifest to set vars
# used by install/uninstall scripts.
# Allows us to be resilient to config changes.

artifact_path=$(
    jq -r '.[] | select(.type == "Binary") | .path' dist/artifacts.json
)
artifact_name=$(basename "${artifact_path}")
brew_prefix=$(brew --prefix)

export BIN_BUILD_PATH="${artifact_path}"
export CMP_BUILD_PATH="build/completions/${artifact_name}.bash"
export MAN_BUILD_PATH="build/manpages/${artifact_name}.1.gz"

export BIN_INSTALL_PATH="/usr/local/bin/${artifact_name}"
export CMP_INSTALL_PATH="${brew_prefix}/etc/bash_completion.d/${artifact_name}.bash"
export MAN_INSTALL_PATH="/usr/local/share/man/man1/${artifact_name}.1.gz"
